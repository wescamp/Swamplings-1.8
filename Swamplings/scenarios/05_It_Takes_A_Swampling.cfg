#textdomain wesnoth-s
[scenario]
    id=05_It_Takes_A_Swampling
    name= _ "It Takes A Swampling"
    map_data="{~add-ons/Swamplings/maps/Archduke01}"
    {SCENARIO_MUSIC "into_the_shadows.ogg"}
    turns=15
	victory_when_enemies_defeated=no

    {FIRST_WATCH}

    next_scenario=06_Rogues_Reward

        [story]
        	[part]
            	story= _ "As tribal chieftain, I was nothing to the humans. But when they mistook me for an assassin, doors began to open for me."
			[/part]
        	[part]
            	story= _ "I had been told to wait outside the hold of the Archduke Kennison. A signal from a sympathetic guard would tell me it was safe to enter."
			[/part]
        	[part]
            	story= _ "Once inside, I was expected to find and kill the Archduke."
            	background="maps/wesnoth.png"
        		show_title=yes
			[/part]
		[/story]

    [side]
        type=Goblin Rouser
        id=Clammie
        name= _ "Clammie"
        unrenamable=yes
        x,y=22,10
        facing=sw
        side=1
        team_name=1
        user_team_name=_"Clammie & Co."
        shroud=yes
        controller=human
		{IS_HERO}
        {GOLD 100 50 25}
    	[modifications]
            {TRAIT_SWAMPSAVVY}
        [/modifications]
    [/side]

    [side]
        side=2
		type=Royal Guard
        id=Phillips
        name= _ "Phillips"
        unrenamable=yes
        canrecruit=yes
        recruit=Spearmen, Bowman
        team_name=2
        user_team_name=_"Archduke's Guards"
        [ai]
            ai_algorithm=idle_ai
        [/ai]
        {GOLD 0 0 0}
 [/side]

# Kennison is on his own side, for now
    [side]
		no_leader=yes
		hidden=yes
        side=3
        team_name=3
        user_team_name=_"3"
        [ai]
            ai_algorithm=idle_ai
        [/ai]
        {GOLD 0 0 0}
   [/side]

# a side that will fight
    [side]
        side=4
		[village]
			x,y=22,1
		[/village]
		[village]
			x,y=19,7
		[/village]
		[village]
			x,y=24,9
		[/village]
		[village]
			x,y=23,15
		[/village]
		[village]
			x,y=12,15
		[/village]
		[village]
			x,y=4,18
		[/village]
        colour=blue
        canrecruit=yes
        recruit=Spearmen, Bowman
        team_name=2
        [ai]
            passive_leader=yes
        [/ai]
		type=Master at Arms
		id=Archduke
		name= _ "Archduke"
        unrenamable=yes
        x,y=22,1
        user_team_name=_"Archduke's Guards"
# by the time this side starts recruiting they will have plenty of gold
        {GOLD 0 14 42}
 	[/side]

	[side]
		side=5
		no_leader=yes
		team_name=5
		user_team_name=_"Wild Things"
	[ai]
		aggression=0.9
		caution=0.0
	[/ai]
		hidden=yes
	[/side]

{ANIMATED_BRAZIER 19 10}

[item]
	x,y=19,10
	image=items/brazier.png
[/item]

[item]
	x,y=10,2
	image=items/archery-target-right.png
[/item]

[item]
	x,y=11,2
	image=items/archery-target-right.png
[/item]

[item]
	x,y=16,2
	image=items/dummy.png
[/item]

[item]
	x,y=9,5
	image=data/add-ons/Swamplings/images/items/bookshelf-full.png
[/item]

[item]
	x,y=17,15
	image=scenery/trapdoor-closed.png
[/item]

[event]
	name=start

{MODIFY_UNIT id=Clammie type "Orcish Assassin"}

	[scroll_to_unit]
		id=Clammie
	[/scroll_to_unit]

[unit]
	type=Spearman
	side=2
	x,y=1,6
    id=Lannyn
    name= _ "Lannyn"
[/unit]

[unit]
	type=Spearman
	side=2
	x,y=25,16
[/unit]

[unit]
	type=Spearman
	side=2
	x,y=25,5
[/unit]

[unit]
	id=Sydd
    name= _ "Sydd"
    unrenamable=yes
    type=Swordsman
    x=19
    y=12
	side=2
[/unit]

[move_unit_fake]
	type=Royal Guard
	side=2
	x=14,18
	y=14,11
[/move_unit_fake]

[unit]
	id=Phillips
    name= _ "Phillips"
    unrenamable=yes
    type=Royal Guard
    x=18
    y=11
	side=2
	canrecruit=yes
[/unit]

        [message]
            speaker=Phillips
            message= _ "Sydd? Report to Lannyn immediately."
        [/message]
        [message]
            speaker=Sydd
            message= _ "<i>mutters</i>"
        [/message]
        [message]
            speaker=Phillips
            message= _ "What's that, Sydd?"
        [/message]
        [message]
            speaker=Sydd
            message= _ "I said it's a fine night to be alive."
        [/message]
        [message]
            speaker=Phillips
            message= _ "I'm sure you did."
        [/message]

# Sydd leaves
        [store_unit]
			variable=sydd_store
			kill=yes
			[filter]
				id=Sydd
			[/filter]
		[/store_unit]
        [move_unit_fake]
            type=Swordsman
            side=2
            x=19,19
            y=12,7
        [/move_unit_fake]

# Phillips goes to brazier
        [store_unit]
		variable=phillips_store
		kill=yes
			[filter]
				id=Phillips
			[/filter]
		[/store_unit]
        [move_unit_fake]
            type=Royal Guard
            side=2
            x=18,18
            y=11,10
        [/move_unit_fake]

# remove nonanimated brazier. animated brazier is 'hiding' behind it (sort of).
[removeitem]
	x,y=19,10
	image=items/brazier.png
[/removeitem]

[delay]
	time=1500
[/delay]

{ITM_GLOWING_BRAZIER 19 10}

[sound_source]
	id=brazier
	sounds=ambient/campfire.ogg
	x,y=19,10
	fade_range=2
	full_range=2
	loop=-1
[/sound_source]

# Phillips exits
        [move_unit_fake]
            type=Royal Guard
            side=2
            x=18,23
            y=10,15
        [/move_unit_fake]

        [objectives]
            side=1
            [objective]
                description= _ "Find the Archduke"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Clammie"
                condition=lose
            [/objective]
            [objective]
                description= _ "Turns run out"
                condition=lose
            [/objective]
			note= _ "Clammie is far from home and can't recruit here."+{NEW_GOLD_CARRYOVER_NOTE_40}
        [/objectives]

[unit]
			id=Kennison
            name= _ "Kennison"
            unrenamable=yes
	#ifdef EASY
			type=Longbowman
		#else
            type=Bowman
	#endif
            profile=portraits/humans/transparent/duelist.png
            x=7
            y=10
			side=3
			[modifications]
				{TRAIT_LOYAL}
			[/modifications]
			{IS_HERO}
[/unit]

{VARIABLE chapter 1}

[/event]

[event]
	name=turn 1	
        [message]
            speaker=Clammie
            message= _ "Well, it's hard to mistake that signal. I see a figure to the northwest. I wonder if that's the Archduke."
            image=data/add-ons/Swamplings/images/portraits/assassin.png
        [/message]
[/event]

# if Clammie attacks spearmen, they vanish
[event]
	name=attack
	    [filter_second]
            type=Spearman
        [/filter_second]
	[if]
		[variable]
			name=chapter
			equals=1
		[/variable]
	[then]
    	[message]
    	   speaker=narrator
    	   image="wesnoth-icon.png"
    	   message= _ "When you approach, the guard gives you a sly wink and steps into a nearby hallway."
		[/message]
		[store_unit]
			[filter]
			    type=Spearman
			[/filter]
			variable=starting_spearmen
			kill=yes
		[/store_unit]
	{VARIABLE guards_are_gone yes}
	[/then]
	[/if]

[/event]

# Clammie meets the quintain
[event]
	name=moveto
	first_time_only=yes
	[filter]
		id=Clammie
		x=15-17
		y=3
	[/filter]
	[if]
		[variable]
			name=chapter
			equals=1
		[/variable]
	[then]
        [message]
            speaker=Clammie
            message= _ "Speak not! I know who you are and your fate is in my hands."
            image=data/add-ons/Swamplings/images/portraits/assassin.png
        [/message]
        [message]
            caption=Quintain
            message= _ "--"
            image=items/dummy.png
        [/message]
        [message]
            speaker=Clammie
            message= _ "No doubt you are frightened by my visage, but I am not as I appear. I was sent here by the human who killed my son. He has escaped my wrath for the moment, but the day will come when I shall repay his perfidy. He is the knight they call Shining. Surely you know him?"
            image=data/add-ons/Swamplings/images/portraits/assassin.png
        [/message]
        [message]
            caption=Quintain
            message= _ "--"
            image=items/dummy.png
        [/message]
        [message]
            speaker=Clammie
            message= _ "Judging by your complete lack of speech or movement, coupled by the fact that you smell strongly of sawdust, I deduce that further conversation with you is pointless. Good night."
            image=data/add-ons/Swamplings/images/portraits/assassin.png
        [/message]
	[/then]
	[/if]
[/event]

# Clammie meet Kennison:
[event]
	name=moveto
	first_time_only=yes
	[filter]
		id=Clammie
		x=7-8
		y=9-11
	[/filter]

# face Clammie toward Kennison
[animate_unit]
         flag=victory
         [filter]
				id=Clammie
         [/filter]
         [facing]
         	[filter]
				id=Kennison
         	[/filter]
         [/facing]
[/animate_unit]

	[scroll_to_unit]
		id=Clammie
	[/scroll_to_unit]

        [message]
            speaker=Kennison
            message= _ "Who are you?"
        [/message]
        [message]
            speaker=Clammie
            message= _ "My name is irrelevant. I have come to warn you--"
            image=data/add-ons/Swamplings/images/portraits/assassin.png
        [/message]
        [message]
            speaker=Kennison
            message= _ "Of the Westford Irrelevants? A fine family, that!"
        [/message]
        [message]
            speaker=Clammie
            message= _ "You're very kind, Duke."
            image=data/add-ons/Swamplings/images/portraits/assassin.png
        [/message]
        [message]
            speaker=Kennison
            message= _ "<i>Arch</i> duke!"
        [/message]
        [message]
            speaker=Clammie
            message= _ "Sir, I want to warn you that the shining knight wants you assassinated!"
            image=data/add-ons/Swamplings/images/portraits/assassin.png
        [/message]
        [message]
            speaker=Kennison
            message= _ "Assassinated? There hasn't been skullduggery like that for generations!"
        [/message]
        [message]
            speaker=Clammie
            message= _ "Not so! Shining had that other guy snuffed too! Lord Prawnball."
            image=data/add-ons/Swamplings/images/portraits/assassin.png
        [/message]
        [message]
            speaker=Kennison
            message= _ "Lord Cornwell? My dear chap, Cornwell died of a fever."
        [/message]
        [message]
            speaker=Clammie
            message= _ "A fever brought on by poison!"
            image=data/add-ons/Swamplings/images/portraits/assassin.png
        [/message]
        [message]
            speaker=Kennison
            message= _ "How am I to believe you? Remove that mask and let me see your face!"
        [/message]
        [message]
            speaker=Clammie
            message= _ "As you wish."
            image=data/add-ons/Swamplings/images/portraits/assassin.png
        [/message]

{MODIFY_UNIT id=Clammie type "Goblin Rouser"}

        [message]
            speaker=Kennison
            message= _ "My word! You're a dwarf!"
        [/message]
        [message]
            speaker=Clammie
            message= _ "A swamp goblin in fact, but that does not matter."
            image=portraits/goblins/rouser.png
        [/message]
        [message]
            speaker=Kennison
            message= _ "How dare you impersonate one of the fine family of Irrelevant?"
        [/message]
        [message]
            speaker=Clammie
            message= _ "You idiot, I was impersonating your assassin!"
            image=portraits/goblins/rouser.png
        [/message]
        [message]
            speaker=Kennison
            message= _ "Well sir, I may be an idiot, but for an assassin you've done an execrable job!"
        [/message]
        [message]
            speaker=Clammie
            message= _ "Perhaps I am not making myself clear--"
            image=portraits/goblins/rouser.png
        [/message]
        [message]
            speaker=Kennison
            message= _ "Perhaps nothing! You've botched this job from the start! Now either you must kill me immediately, or I shall call for my guards and they shall kill you!"
        [/message]
        [message]
            speaker=Clammie
            message= _ "I'm beginning to wonder … are you really the Archduke?"
            image=portraits/goblins/rouser.png
        [/message]
        [message]
            speaker=Kennison
            message= _ "All right, I suppose the intrigue has become a bit convoluted. The Archduke and I had a little wager. I told him I believe in the basic honesty and integrity of any man, and assured him I could reason with the assassin that he knew would arrive soon. The Archduke chose to take an extended holiday at his summer villa."
        [/message]
        [message]
            speaker=Clammie
            message= _ "I suppose he believes in the basic dishonesty and ruthlessness of his fellow man."
            image=portraits/goblins/rouser.png
        [/message]
        [message]
            speaker=Kennison
            message= _ "Quite bright for a swamp goblin."
        [/message]
        [message]
            speaker=Clammie
            message= _ "So we are both impostors?"
            image=portraits/goblins/rouser.png
        [/message]
        [message]
            speaker=Kennison
            message= _ "The only difference is, I aspire to impersonate above my station and you stoop to impersonate beneath yours."
        [/message]
        [message]
            speaker=Clammie
            message= _ "If you're not Kennison, what's your real name?"
            image=portraits/goblins/rouser.png
        [/message]
        [message]
            speaker=Kennison
            message= _ "Kennison. I'm the Archduke's uncle, and in his mind, totally expendable."
        [/message]

# enter Phillips
        [move_unit_fake]
            type=Royal Guard
            side=2
            x=8,6
            y=14,10
        [/move_unit_fake]
		[unstore_unit]
			variable=phillips_store
			x,y=6,10
		[/unstore_unit]

        [message]
            speaker=Phillips
            message= _ "Excuse me, the men and I have been wondering what's taking so long?"
        [/message]
        [message]
            speaker=Kennison
            message= _ "Please be patient … my assassin and I have almost reached an agreement."
        [/message]
        [message]
            speaker=Phillips
            message= _ "Well, we need at least one dead body in here if we're to spread the rumor of the Archduke's assassination. So which of you will take the job? Ye gods! He's a troll!"
        [/message]
        [message]
            speaker=Kennison
            message= _ "You really must study your bestiary, Phillips!"
        [/message]
        [message]
            speaker=Phillips
            message= _ "We can't pass a troll corpse off as the Archduke!"
        [/message]
        [message]
            speaker=Kennison
            message= _ "Why are you looking at me that way, Phillips? Do you think I will not defend myself?"
        [/message]

#Kennison attacks Phillips.
[animate_unit]
         flag=attack
         with_bars=no
         [filter]
			id=Kennison
         [/filter]
         [primary_attack]
            name=bow
         [/primary_attack]
         hits=yes
         [facing]
         	[filter]
				id=Phillips
         	[/filter]
         [/facing]
         [animate]
         	flag=defend
         [filter_second]
         		id=Phillips
         [/filter_second]
         hits=yes
         with_bars=no
         [facing]
         [filter]
			id=Kennison
         [/filter]
         [/facing]
         [/animate]
[/animate_unit]

#Kennison attacks Phillips.
[animate_unit]
         flag=attack
         with_bars=no
         [filter]
			id=Kennison
         [/filter]
         [primary_attack]
            name=bow
         [/primary_attack]
         hits=yes
         [facing]
         	[filter]
				id=Phillips
         	[/filter]
         [/facing]
         [animate]
         	flag=defend
         [filter_second]
         	id=Phillips
         [/filter_second]
         hits=yes
         with_bars=no
         [facing]
         [filter]
			id=Kennison
         [/filter]
         [/facing]
         [/animate]
[/animate_unit]

# Phillips is injured
        [store_unit]
            [filter]
                id=Phillips
            [/filter]

            variable=phillips_store
        [/store_unit]

        {VARIABLE_OP phillips_store.hitpoints add -10}

        [unstore_unit]
            variable=phillips_store
            find_vacant=no
            text="10"
            {COLOR_HARM}
        [/unstore_unit]

        [redraw]
        [/redraw]

		[sound]
			name=human-hit-2.ogg
		[/sound]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Phillips
            message= _ "By Haldric's onions!"
        [/message]
        [message]
            speaker=Kennison
            message= _ "Poor form, Phillips!"
        [/message]

# Phillips counterattacks
[animate_unit]
         flag=attack
         with_bars=no
         [filter]
			id=Phillips
         [/filter]
         [primary_attack]
            name=sword
         [/primary_attack]
         hits=no
         [facing]
         	[filter]
				id=Kennison
         	[/filter]
         [/facing]
         [animate]
         	flag=defend
         [filter_second]
         		id=Kennison
         [/filter_second]
         hits=no
         with_bars=no
         [facing]
         [filter]
			id=Phillips
         [/filter]
         [/facing]
         [/animate]
[/animate_unit]

        [message]
            speaker=Kennison
            message= _ "Methinks you've been skipping your practice time with friend quintain, Phillips!"
        [/message]
         [message]
            speaker=Phillips
            message= _ "INTRUDERS!"
        [/message]

{REPLACE_SCENARIO_MUSIC frantic.ogg}

# Phillips moves to keep
        [store_unit]
		variable=phillips_store
		kill=yes
			[filter]
				id=Phillips
			[/filter]
		[/store_unit]
        [move_unit_fake]
            type=Royal Guard
            side=2
            x=6,12
            y=10,10
        [/move_unit_fake]
		[unstore_unit]
			variable=phillips_store
			x,y=12,10
		[/unstore_unit]

# in normal & hard games, Sydd returns
#ifndef EASY
		[unstore_unit]
			variable=sydd_store
			x,y=19,7
		[/unstore_unit]
#endif

# if guards are gone, they return:
[if]
	[variable]
		name=guards_are_gone
		equals=yes
	[/variable]
[then]
	{FOREACH starting_spearmen i}
		[unstore_unit]
			variable=starting_spearmen[$i]
			find_vacant=yes
		[/unstore_unit]
	{NEXT i}
[/then]
[/if]

# change all side 2 units to side 4, because side 2's ai_algorithm seems to be stuck on stupid (either that, or I am).
{MODIFY_UNIT side=2 side 4}

# set a variable to count ten turns
{VARIABLE ah_yes $turn_number}
{VARIABLE_OP ah_yes add 10}

# To see what's going on:
#{DEBUG_MSG "ah_yes equals $ah_yes"}

{MODIFY_UNIT id=Kennison side 1}

# give Clammie some moves.
{MODIFY_UNIT id=Clammie moves 5}

        [message]
            speaker=Clammie
            message= _ "Kennison? Is there a back door to this cottage?"
            image=portraits/goblins/rouser.png
        [/message]
        [message]
            speaker=Kennison
            message= _ "Why yes, there is a secret passage, come to think of it. Now let's see if I recall where it is ..."
        [/message]

        [objectives]
	      summary= _ "New Objectives:"
            side=1
            [objective]
                description= _ "Survive ten turns, when Kennison will recall the location of the secret passage."
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Clammie"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Kennison"
                condition=lose
            [/objective]
			note= _ "Hint: You're seriously outnumbered! Run!"+{NEW_GOLD_CARRYOVER_NOTE_40}
			[/objectives]

	[modify_turns]
		value=25
	[/modify_turns]

# make Clammie slippery awhile
    {FORCE_CHANCE_TO_HIT side=4 id="Clammie" 0 (
        [variable]
            name=turn_number
            less_than=10
        [/variable]
    )}

{VARIABLE chapter 2}

[/event]

# Clammie at trapdoor
[event]
	name=moveto
	first_time_only=no
	[filter]
		id=Clammie
		x=17
		y=15
	[/filter]
	[if]
		[variable]
			name=chapter
			equals=2
		[/variable]
	[then]
		[if]
			[variable]
				name=hesaidthis
				not_equals=yes
			[/variable]
		[then]
        [message]
            speaker=Clammie
            message= _ "Locked!"
            image=portraits/goblins/rouser.png
        [/message]
        [message]
            speaker=Kennison
            message= _ "That merely leads to the drainage system. The Archduke's plumbing is the talk of the town."
        [/message]
        {VARIABLE hesaidthis yes}
		[/then]
        [/if]
	[/then]
	[/if]
[/event]

# This checks each turn to see if we're ready for K to remember:
[event]
	name=new turn
	first_time_only=no
        [if]
		[variable]
			name=chapter
			equals=2
		[/variable]
        [then]
			[if]
				[variable]
					name=ah_yes
					equals=$turn_number
				[/variable]
			[then]
				[fire_event]
					name=remember
				[/fire_event]
			[/then]
			[/if]
		[/then]
		[/if]
[/event]

[event]
	name=remember

        [message]
            speaker=Kennison
            message= _ "Ah yes, now I recall! The secret passage was walled up when they rebuilt last year ... how could I have forgotten?"
        [/message]

{VARIABLE chapter 3}

		[message]
            speaker=Clammie
            message= _ "In that case, a new plan would be wise."
        [/message]
        [message]
            speaker=Kennison
            message= _ "I concur! These blighters don't seem satisfied with any of the corpses we've given them … do you think they're after the family resemblance?"
        [/message]
		[message]
            speaker=Clammie
            message= _ "We'll break the lock off that trap door and escape through the drain."
        [/message]
        [message]
            speaker=Kennison
            message= _ "This cloak could use a bit of a soak. Lead on!"
        [/message]

	[modify_turns]
		value=40
	[/modify_turns]

        [objectives]
	      summary= _ "New Objectives:"
            side=1
            [objective]
                description= _ "Move Clammie to the trap door"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Clammie"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Kennison"
                condition=lose
            [/objective]
            [objective]
                description= _ "Turns run out"
                condition=lose
            [/objective]
			note={NEW_GOLD_CARRYOVER_NOTE_40}
			[/objectives]
[/event]

# Clammie at trapdoor chapt 3
[event]
	name=moveto
	first_time_only=no
	[filter]
		id=Clammie
		x=17
		y=15
	[/filter]
	[if]
		[variable]
			name=chapter
			equals=3
		[/variable]
	[then]
	# remove icon
	[removeitem]
		x,y=17,15
		image=scenery/trapdoor-closed.png
	[/removeitem]
	[sound]
		name=fist.ogg
	[/sound]
	[item]
		x,y=17,15
		image=scenery/trapdoor-open.png
	[/item]

{TELEPORT_UNIT (id=Clammie) 17 26}

	[remove_shroud]
		x,y=17,26
		radius=2
	[/remove_shroud]

	[scroll_to_unit]
		id=Clammie
	[/scroll_to_unit]

		[sound]
			name=water-blast.wav
		[/sound]

        [message]
            speaker=Clammie
            message= _ "So this is what they call plumbing. Kennison, where are you?"
            image=portraits/goblins/rouser.png
        [/message]

	[scroll_to_unit]
		id=Kennison
	[/scroll_to_unit]

        [message]
            speaker=Kennison
            message= _ "On your heels, brave sir!"
        [/message]

{MOVE_UNIT (id=Kennison) 17 15}
{TELEPORT_UNIT (id=Kennison) 16 25}

		[sound]
			name=water-blast.wav
		[/sound]

	[place_shroud]
		x=1-25
		y=1-21
	[/place_shroud]

{REPLACE_SCENARIO_MUSIC into_the_shadows.ogg}

        [message]
            speaker=Kennison
            message= _ "Fascinating. I always thought there was a ladder."
        [/message]
        [message]
            speaker=Clammie
            message= _ "Do you think they'll follow us down here?"
            image=portraits/goblins/rouser.png
        [/message]
        [message]
            speaker=Kennison
            message= _ "Unlikely. I've seen their wages."
        [/message]
        [message]
            speaker=Clammie
            message= _ "Which way to the egress?"
            image=portraits/goblins/rouser.png
        [/message]
        [message]
            speaker=Kennison
            message= _ "Yearning for the bogs, my friend? The way out should be due east."
        [/message]

	[remove_shroud]
		x,y=25,25
		radius=2
	[/remove_shroud]

    {HIGHLIGHT_IMAGE 25 25 items/gohere.png ()}

	[scroll_to_unit]
		id=Clammie
	[/scroll_to_unit]

        [objectives]
	      summary= _ "New Objectives:"
            side=1
            [objective]
                description= _ "Move Clammie to the exit"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Clammie"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Kennison"
                condition=lose
            [/objective]
            [objective]
                description= _ "Turns run out"
                condition=lose
            [/objective]
			note={NEW_GOLD_CARRYOVER_NOTE_40}
			[/objectives]

	[modify_turns]
		value=50
	[/modify_turns]

{VARIABLE chapter 4}

	[/then]
	[/if]
[/event]

# Greta is found in village
[event]
	name=moveto
	[filter]
		side=1
		x,y=18,24
	[/filter]

# get variable on Clammie's location. Use to position Greta
        [store_unit]
            variable=clammie_store
            [filter]
                id=Clammie
            [/filter]
        [/store_unit]
        {VARIABLE temp_x $clammie_store.x}
        {VARIABLE temp_y $clammie_store.y}

		[move_unit_fake]
            type=Giant Rat
            side=3
            x=18,$temp_x
            y=24,$temp_y
        [/move_unit_fake]

     [unit]
            id=Greta
            name= _ "Greta"
            unrenamable=yes
            type=Bosavi
            x=$temp_x
            y=$temp_y
			side=5
            {IS_LOYAL}
        [/unit]

# animate Clammie to face Greta
[animate_unit]
         flag=victory
         [filter]
				id=Clammie
         [/filter]
         [facing]
         	[filter]
				id=Greta
         	[/filter]
         [/facing]
[/animate_unit]

# animate Greta to face Clammie
[animate_unit]
         flag=victory
         [filter]
				id=Greta
         [/filter]
         [facing]
         	[filter]
				id=Clammie
         	[/filter]
         [/facing]
[/animate_unit]

        [message]
            speaker=Clammie
            message= _ "That unfortunate creature! It looks like she hasn't eaten in days!"
            image=portraits/goblins/rouser.png
        [/message]
        [message]
            speaker=Kennison
            message= _ "What creature? All I see is a nasty old rat."
        [/message]
        [message]
            speaker=Clammie
            message= _ "Perhaps she'd like a nibble of duckweed pods."
            image=portraits/goblins/rouser.png
        [/message]

# Greta befriends Clammie
		[sound]
			name=bite-small.ogg
			repeat=2
		[/sound]

{MODIFY_UNIT id=Greta side 1}

        [message]
            speaker=Clammie
            message= _ "I will name you Greta!"
            image=portraits/goblins/rouser.png
        [/message]
        [message]
            speaker=Kennison
            message= _ "It appears another ally has cast its lot with you. At this rate, we'll be an army before you arrive home."
        [/message]
        [message]
            speaker=Clammie
            message= _ "It's no harder than training a bat."
            image=portraits/goblins/rouser.png
        [/message]
        [message]
            speaker=Kennison
            message= _ "I suppose that is so. -- What's that sound?"
        [/message]
        [message]
            speaker=Clammie
            message= _ "Eh?"
            image=portraits/goblins/rouser.png
        [/message]
        [message]
            speaker=Kennison
            message= _ "Probably nothing ... but it occurs to me that Greta may not be the only one of her kind down here."
        [/message]

# determine number of rats by difficulty
[set_variable]
	name=ratfoes
	{QUANTITY value 7 10 14}
[/set_variable]

# add some rats
{SCATTER_UNITS $ratfoes "Giant Rat" 3 (
    x=2-24
    y=23-32
    
	# prevents two rats in the same hex:
    [not]
        [filter]
        [/filter]
    [/not]
    
    # prevents two rats in adjacent hexes:
    [not]
        [filter_adjacent_location]
            [filter]
            [/filter]
        [/filter_adjacent_location]
    [/not]
    
    # keeps rats from appearing in cave walls or stuck in deep water (not sure if this works right):
    [not]
        [filter]
        	[filter_location]
				terrain=Wo,Xu
         	[/filter_location]
        [/filter]
     [/not]
) (
     side=5
     random_traits=yes
)}

# Team 5 appears in status table
[modify_side]
	side=5
	hidden=no
[/modify_side]

[/event]

# getting out of sewer
[event]
	name=moveto
	[filter]
		id=Clammie
		x=25
		y=25
	[/filter]
        [message]
            speaker=Kennison
            message= _ "My dear swamp goblin, the days when I was welcome in Fursnatch appear to have ended. You have saved my life and I am in your debt. Is it possible we may cast our lot together? My skills may be useful to you and your tribe."
        [/message]
        [message]
            speaker=Clammie
            message= _ "Nothing could please me more, Kennison. Perhaps you can teach some of my people to use a bow. I must warn you that goblins are not quick learners, however."
            image=portraits/goblins/rouser.png
        [/message]
        [message]
            speaker=Kennison
            message= _ "That is fine. I am a very slow teacher so we should get on swimmingly."
        [/message]

		[sound]
			name=ambient/morning.ogg
		[/sound]

[modify_side]
	side=1
	shroud=no
[/modify_side]

# Archduke gets a message
[kill]
	id=Archduke
[/kill]
[unit]
	type=Master at Arms
	id=Archduke
	name= _ "Archduke"
    unrenamable=yes
    x,y=22,1
	side=4
	{IS_HERO}
[/unit]

	[scroll_to_unit]
		id=Archduke
	[/scroll_to_unit]

#	[remove_shroud]
#		x,y=22,1
#		radius=3
#	[/remove_shroud]

[unit]
	type=Footpad
	gender=female
	side=4
	x,y=25,1
	id=Dulonna
	name= _ "Dulonna"
[/unit]

{MOVE_UNIT (id=Dulonna) 23 2}

        [message]
            speaker=Archduke
            message= _ "A botch, you say?"
        [/message]
        [message]
            speaker=Dulonna
            message= _ "Your uncle escaped, and no one else could successfully impersonate your corpse, sir."
        [/message]
        [message]
            speaker=Archduke
            message= _ "No matter. Spread word that my uncle attempted to take my life. Put a price on his head – a thousand gold will do. I want no suspicion to fall upon Shining! He cannot know we are on to him!"
        [/message]

# Shining gets a message

[unit]
    type=Knight
    id=Shining
    name= _ "Knight Shining"
    side=2
    x,y=2,2
    facing=se
	{IS_HERO}
	[modifications]
        {TRAIT_INTELLIGENT}
        {TRAIT_QUICK}
    [/modifications]
[/unit]

	[scroll_to_unit]
		id=Shining
	[/scroll_to_unit]

[unit]
	type=Ruffian
	side=2
	x,y=5,1
	id=Blinvan
	name= _ "Blinvan"
[/unit]

{MOVE_UNIT (id=Blinvan) 3 2}

        [message]
            speaker=Shining
            message= _ "A botch, you say?"
        [/message]
        [message]
            speaker=Blinvan
            message= _ "Rashki and the Archduke are nowhere to be found. But the Archduke has placed a bounty on his uncle's head."
        [/message]
        [message]
            speaker=Shining
            message= _ "The fool thinks his uncle is behind this. Good! Rashki has been paid well. He shall finish this job properly. But what if this uncle is found alive? He may well tell more than ought be known! I'll collect this bounty myself -- and ensure the Archduke remains in the dark."
        [/message]
        [message]
            speaker=Blinvan
            message= _ "But where would the rascal hide? No town would give him shelter."
        [/message]
        [message]
            speaker=Shining
            message= _ "Indeed, the only place he can hide is Pogo Bog! I heard a healer took up residence there. Perhaps I'll start my search at the healer's shack."
        [/message]

        [endlevel]
            result=victory
            bonus=yes
            {NEW_GOLD_CARRYOVER 40}

			{CLEAR_VARIABLE chapter}
			{CLEAR_VARIABLE clammie_store}
			{CLEAR_VARIABLE hesaidthis}
			{CLEAR_VARIABLE ratfoes}
			{CLEAR_VARIABLE ah_yes}
			{CLEAR_VARIABLE temp_x}
			{CLEAR_VARIABLE temp_y}
			{CLEAR_VARIABLE guards_are_gone}
			{CLEAR_VARIABLE starting_spearmen}

# store Sydd if he's alive
	[if]
        [have_unit]
            side=2
            id=Sydd
        [/have_unit]
    [then]
        [store_unit]
			variable=sydd_store
			kill=yes
			[filter]
				id=Sydd
			[/filter]
		[/store_unit]
	[/then]
	[/if]

# store Phillips if he's alive
	[if]
        [have_unit]
            side=2
            id=Phillips
        [/have_unit]
    [then]
        [store_unit]
		variable=phillips_store
		kill=yes
			[filter]
				id=Phillips
			[/filter]
		[/store_unit]
	[/then]
	[/if]

        [/endlevel]
[/event]

# out of time, chapt 3
[event]
        name=time over
        [message]
            speaker=Clammie
            message= _ "Out of time!"
            image=portraits/goblins/rouser.png
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
[/event]

# Greta's death
    [event]
        name=die
        [filter]
            id=Greta
        [/filter]
        [message]
            speaker=Clammie
            message= _ "A tiny beast you were, Greta, but a noble fighter."
            image=portraits/goblins/rouser.png
        [/message]
    [/event]

# Clammie's death
    [event]
        name=die
        [filter]
            id=Clammie
        [/filter]
        [message]
            speaker=Clammie
            message= _ "Perhaps I need a better strategy ..."
            image=portraits/goblins/rouser.png
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

# Kennison's death
    [event]
        name=die
        [filter]
            id=Kennison
        [/filter]
        [message]
            speaker=Kennison
            message= _ "Clever stroke, that! Well executed, quite bold ... but most unsporting of you, old bean!"
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

# this one won't trigger no matter what. Message tags come first, then K switches sides, and somehow all memory of the attack vanishes.
# if Clammie attacks Kennison
    [event]
        name=attack
        [filter]
            id=Clammie
        [/filter]
        [filter_second]
            id=Kennison
        [/filter_second]
        [message]
            speaker=Kennison
            message= _ "You've fallen right into the Archduke's trap! Guards!"
        [/message]
		{MOVE_UNIT (id=Phillips) 10 10}
		{MOVE_UNIT (id=Sydd) 10 9}
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

[event]
    name=attacker hits
	first_time_only=yes
    [filter_second]
        id=Clammie
    [/filter_second]
    [message]
        speaker=Clammie
        message= _ "Under different conditions, I'd stand my ground and fight. ... However, the odds seem tipped against me."
    [/message]
[/event]

[event]
    name=attacker hits
	first_time_only=yes
    [filter]
        id=Kennison
    [/filter]
	# to avoid talking rats:
    	[filter_second]
        	race=human
    	[/filter_second]
    [message]
        speaker=second_unit
        message= _ "Arrrrh! You pedigreed bastard!"
    [/message]
    [message]
        speaker=Kennison
        message= _ "That's an oxymoron, moron!"
    [/message]
[/event]

[/scenario]